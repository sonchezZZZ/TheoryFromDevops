# Обзор сетей Docker

Сеть Docker построена на Container Network Model (CNM), которая позволяет кому угодно создать свой собственный сетевой драйвер. Таким образом, у контейнеров есть доступ к разным типам сетей и они могут подключаться к нескольким сетям одновременно. Помимо различных сторонних сетевых драйверов, у самого Docker-а есть 4 встроенных:


- Bridge: в этой сети контейнеры запускаются по умолчанию. Связь устанавливается через bridge-интерфейс на хосте. У контейнеров, которые используют одинаковую сеть, есть своя собственная подсеть, и они могут передавать данные друг другу по умолчанию.
- Host: этот драйвер дает контейнеру доступ к собственному пространству хоста (контейнер будет видеть и использовать тот же интерфейс, что и хост).
- Macvlan: этот драйвер дает контейнерам прямой доступ к интерфейсу и суб-интерфейсу (vlan) хоста. Также он разрешает транкинг.
- Overlay: этот драйвер позволяет строить сети на нескольких хостах с Docker (обычно на Docker Swarm кластере). У контейнеров также есть свои адреса сети и подсети, и они могут напрямую обмениваться данными, даже если они располагаются физически на разных хостах.

Сетевые драйвера Bridge и Overlay, возможно, используются чаще всего, поэтому в этой статье я буду больше уделять им внимание.

Сводка сетевых драйверов 

- Определяемые пользователем мостовые сети лучше всего подходят, когда вам нужно, чтобы несколько контейнеров взаимодействовали на одном хосте Docker.
- Хост-сети лучше всего подходят, когда сетевой стек не должен быть изолирован от хоста Docker, но вы хотите, чтобы были изолированы другие аспекты контейнера.
- Оверлейные сети лучше всего подходят, когда вам нужны контейнеры, работающие на разных хостах Docker, для связи или когда несколько приложений работают вместе, используя службы роя.
- Сети Macvlan лучше всего подходят, когда вы мигрируете с установки виртуальной машины или вам нужно, чтобы ваши контейнеры выглядели как физические хосты в вашей сети, каждый с уникальным MAC-адресом.
Сторонние сетевые плагины позволяют интегрировать Docker со специализированными сетевыми стеками.

## Bridge

С точки зрения сети мостовая сеть — это устройство канального уровня, которое перенаправляет трафик между сегментами сети. Мост может быть аппаратным устройством или программным устройством, работающим в ядре хост-машины.

С точки зрения Docker, мостовая сеть использует программный мост, который позволяет контейнерам, подключенным к одной мостовой сети, взаимодействовать, обеспечивая при этом изоляцию от контейнеров, которые не подключены к этой мостовой сети. Драйвер моста Docker автоматически устанавливает правила на хост-компьютере, чтобы контейнеры в разных сетях моста не могли напрямую взаимодействовать друг с другом.

Сети-мосты применяются к контейнерам, работающим на одном хосте демона Docker. Для связи между контейнерами, работающими на разных хостах демона Docker, вы можете либо управлять маршрутизацией на уровне ОС, либо использовать оверлейную сеть.

Когда вы запускаете Docker, сеть моста по умолчанию (также называемая bridge) создается автоматически, и только что запущенные контейнеры подключаются к ней, если не указано иное. Вы также можете создавать определяемые пользователем пользовательские мостовые сети. Мостовые сети, определяемые пользователем, превосходят bridge сеть по умолчанию.

### Различия между пользовательскими мостами и мостом по умолчанию

- **Определяемые пользователем мосты обеспечивают автоматическое разрешение DNS между контейнерами .**

Контейнеры в мостовой сети по умолчанию могут обращаться друг к другу только по IP-адресам, если вы не используете --linkвариант , который считается устаревшим. В пользовательской мостовой сети контейнеры могут разрешать друг друга по имени или псевдониму.

- ***Пользовательские мосты обеспечивают лучшую изоляцию .***

Все контейнеры без --network указанного, присоединяются к сети моста по умолчанию. Это может быть рискованно, так как тогда несвязанные стеки/сервисы/контейнеры могут обмениваться данными.

- ***Контейнеры можно подключать и отключать от определяемых пользователем сетей на лету .***

В течение всего срока службы контейнера вы можете на лету подключать или отключать его от пользовательских сетей. Чтобы удалить контейнер из сети моста по умолчанию, вам нужно остановить контейнер и создать его заново с другими сетевыми параметрами.

- ***Каждая определяемая пользователем сеть создает настраиваемый мост .***

Если ваши контейнеры используют мостовую сеть по умолчанию, вы можете настроить ее, но все контейнеры используют одни и те же параметры, такие как MTU и iptablesправила. Кроме того, настройка сети моста по умолчанию происходит вне самого Docker и требует перезапуска Docker.


## Host

Если вы используете hostсетевой режим для контейнера, сетевой стек этого контейнера не изолирован от хоста Docker (контейнер разделяет сетевое пространство имен хоста), и контейнеру **не выделяется** собственный IP-адрес. Например, если вы запускаете контейнер, который привязывается к порту 80, и используете host сеть, приложение контейнера будет доступно через порт 80 по IP-адресу хоста.

Сеть в режиме хоста может быть полезна для оптимизации производительности и в ситуациях, когда контейнеру необходимо обрабатывать большой диапазон портов, поскольку он не требует трансляции сетевых адресов (NAT) и для каждого порта не создается «userland-proxy».

Сетевой драйвер хоста работает только на хостах Linux и не поддерживается в Docker Desktop для Mac, Docker Desktop для Windows или Docker EE для Windows Server.

Вы также можете использовать hostсеть для службы роя, перейдя --network host к docker service createкоманде. В этом случае управляющий трафик (трафик, связанный с управлением рой и службой) по-прежнему отправляется через оверлейную сеть, но отдельные контейнеры служб роя отправляют данные, используя хост-сеть и порты демона Docker. Это создает некоторые дополнительные ограничения. Например, если контейнер службы привязан к порту 80, только один контейнер службы может работать на данном узле роя.

## Overlay

Сетевой overlay драйвер создает распределенную сеть между несколькими узлами демона Docker. Эта сеть находится поверх (перекрывает) сети, специфичные для хоста, позволяя контейнерам, подключенным к ней (включая контейнеры службы swarm), безопасно обмениваться данными при включенном шифровании. Docker прозрачно обрабатывает маршрутизацию каждого пакета от и к правильному хосту демона Docker и правильному контейнеру назначения.

Когда вы инициализируете рой или присоединяете хост Docker к существующему рою, на этом хосте Docker создаются две новые сети:

оверлейная сеть под названием ingress, которая обрабатывает трафик управления и данных, связанный со службами роя. Когда вы создаете swarm-сервис и не подключаете его к определяемой пользователем оверлейной сети, он подключается к ingress сети по умолчанию.
мостовая сеть, называемая docker_gwbridge, которая соединяет отдельный демон Docker с другими демонами, участвующими в рое.

